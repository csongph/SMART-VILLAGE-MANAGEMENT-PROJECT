#!/usr/bin/env python3
"""
start.py - Run Backend and Frontend for SMART VILLAGE project
Author: SMART VILLAGE MANAGEMENT SYSTEM
Description: Automated launcher for Flask backend and HTML frontend
"""

import subprocess
import webbrowser
import os
import time
import socket
import requests
from pathlib import Path
import sys
import signal

# ==================== Configuration ====================
# Path à¸«à¸¥à¸±à¸à¸‚à¸­à¸‡à¹‚à¸›à¸£à¹€à¸ˆà¸„ (FINAL PROJECT folder)
PROJECT_ROOT = Path(__file__).parent.absolute()
FRONTEND_FILE = PROJECT_ROOT / "Frontend" / "index.html"
BACKEND_FILE = PROJECT_ROOT / "backend" / "app.py"

# Backend configuration
BACKEND_HOST = "127.0.0.1"
BACKEND_PORT = 5000
MAX_STARTUP_WAIT = 30  # à¸§à¸´à¸™à¸²à¸—à¸µà¸ªà¸¹à¸‡à¸ªà¸¸à¸”à¸—à¸µà¹ˆà¸£à¸­à¹ƒà¸«à¹‰ backend à¹€à¸£à¸´à¹ˆà¸¡à¸—à¸³à¸‡à¸²à¸™
CHECK_INTERVAL = 0.5   # à¸§à¸´à¸™à¸²à¸—à¸µà¸£à¸°à¸«à¸§à¹ˆà¸²à¸‡à¸à¸²à¸£à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š backend

# ==================== Functions ====================

def print_banner():
    """à¹à¸ªà¸”à¸‡ banner à¹€à¸¡à¸·à¹ˆà¸­à¹€à¸£à¸´à¹ˆà¸¡à¹‚à¸›à¸£à¹à¸à¸£à¸¡"""
    banner = """
    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    â•‘                                                       â•‘
    â•‘       ğŸ˜ï¸  SMART VILLAGE MANAGEMENT SYSTEM ğŸ˜ï¸         â•‘
    â•‘                                                       â•‘
    â•‘              Starting Application...                 â•‘
    â•‘                                                       â•‘
    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    """
    print(banner)

def check_python_version():
    """à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¹€à¸§à¸­à¸£à¹Œà¸Šà¸±à¸™ Python"""
    if sys.version_info < (3, 7):
        print("âŒ Error: Python 3.7 or higher is required!")
        print(f"   Current version: {sys.version}")
        sys.exit(1)
    print(f"âœ… Python version: {sys.version.split()[0]}")

def check_port_available(host, port):
    """à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸§à¹ˆà¸² port à¸§à¹ˆà¸²à¸‡à¸«à¸£à¸·à¸­à¹„à¸¡à¹ˆ"""
    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    sock.settimeout(1)
    try:
        sock.connect((host, port))
        sock.close()
        return False  # Port is in use
    except (socket.timeout, ConnectionRefusedError, OSError):
        return True  # Port is available
    finally:
        sock.close()

def check_dependencies():
    """à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š Python packages à¸—à¸µà¹ˆà¸ˆà¸³à¹€à¸›à¹‡à¸™"""
    print("\nğŸ“¦ Checking dependencies...")
    
    required_packages = {
        'flask': 'Flask',
        'requests': 'requests'
    }
    
    missing_packages = []
    
    for module_name, package_name in required_packages.items():
        try:
            __import__(module_name)
            print(f"âœ… {package_name} installed")
        except ImportError:
            print(f"âŒ {package_name} NOT installed")
            missing_packages.append(package_name)
    
    if missing_packages:
        print(f"\nâš ï¸  Missing packages: {', '.join(missing_packages)}")
        print("   Install them using:")
        print(f"   pip install {' '.join(missing_packages)}")
        
        response = input("\n   Do you want to continue anyway? (y/n): ")
        if response.lower() != 'y':
            sys.exit(1)
    else:
        print("âœ… All dependencies installed!\n")

def check_files():
    """à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸§à¹ˆà¸²à¹„à¸Ÿà¸¥à¹Œà¸—à¸µà¹ˆà¸ˆà¸³à¹€à¸›à¹‡à¸™à¸¡à¸µà¸­à¸¢à¸¹à¹ˆà¸«à¸£à¸·à¸­à¹„à¸¡à¹ˆ"""
    print("ğŸ“‹ Checking required files...")
    
    files_ok = True
    
    # à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š Backend
    if BACKEND_FILE.exists():
        print(f"âœ… Backend found: {BACKEND_FILE}")
    else:
        print(f"âŒ Backend NOT found: {BACKEND_FILE}")
        files_ok = False
    
    # à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š Frontend
    if FRONTEND_FILE.exists():
        print(f"âœ… Frontend found: {FRONTEND_FILE}")
    else:
        print(f"âŒ Frontend NOT found: {FRONTEND_FILE}")
        files_ok = False
    
    if not files_ok:
        print("\nâŒ Error: Required files are missing!")
        print("   Please check your project structure:")
        print(f"   - Backend: {BACKEND_FILE}")
        print(f"   - Frontend: {FRONTEND_FILE}")
        sys.exit(1)
    
    print("âœ… All required files found!\n")

def is_backend_ready(host, port, timeout=1):
    """à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸§à¹ˆà¸² backend à¸à¸£à¹‰à¸­à¸¡à¹ƒà¸Šà¹‰à¸‡à¸²à¸™à¸«à¸£à¸·à¸­à¹„à¸¡à¹ˆ"""
    try:
        response = requests.get(
            f"http://{host}:{port}/",
            timeout=timeout
        )
        return response.status_code in [200, 404]  # à¸–à¹‰à¸²à¸•à¸­à¸šà¸à¸¥à¸±à¸šà¸¡à¸²à¹à¸ªà¸”à¸‡à¸§à¹ˆà¸² server à¸—à¸³à¸‡à¸²à¸™
    except requests.exceptions.RequestException:
        return False

def run_backend():
    """à¹€à¸£à¸´à¹ˆà¸¡à¸•à¹‰à¸™ Flask backend server"""
    print("ğŸš€ Starting Backend Server...")
    
    # à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸§à¹ˆà¸² port à¸§à¹ˆà¸²à¸‡à¸«à¸£à¸·à¸­à¹„à¸¡à¹ˆ
    if not check_port_available(BACKEND_HOST, BACKEND_PORT):
        print(f"âš ï¸  Warning: Port {BACKEND_PORT} is already in use!")
        print(f"   Backend might already be running on http://{BACKEND_HOST}:{BACKEND_PORT}")
        response = input("   Do you want to continue? (y/n): ")
        if response.lower() != 'y':
            sys.exit(1)
    
    # à¹ƒà¸Šà¹‰ absolute path
    backend_file = BACKEND_FILE.resolve()
    backend_dir = backend_file.parent
    
    # à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸„à¸§à¸²à¸¡à¸–à¸¹à¸à¸•à¹‰à¸­à¸‡à¸‚à¸­à¸‡ path
    if not backend_file.exists():
        print(f"âŒ Backend file not found: {backend_file}")
        sys.exit(1)
    
    if not backend_dir.is_dir():
        print(f"âŒ Backend directory invalid: {backend_dir}")
        sys.exit(1)
    
    # à¹à¸ªà¸”à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥ debug
    print(f"   ğŸ“‚ Working directory: {backend_dir}")
    print(f"   ğŸ“„ Backend file: {backend_file.name}")
    print(f"   ğŸŒ Server will run on: http://{BACKEND_HOST}:{BACKEND_PORT}")
    
    try:
        # à¹€à¸£à¸´à¹ˆà¸¡à¸•à¹‰à¸™ subprocess à¹‚à¸”à¸¢à¹„à¸¡à¹ˆà¹à¸ªà¸”à¸‡ console window (Windows)
        startupinfo = None
        if sys.platform == 'win32':
            startupinfo = subprocess.STARTUPINFO()
            startupinfo.dwFlags |= subprocess.STARTF_USESHOWWINDOW
        
        # à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸² environment variables à¸ªà¸³à¸«à¸£à¸±à¸š UTF-8
        env = os.environ.copy()
        env['PYTHONIOENCODING'] = 'utf-8'
        env['PYTHONLEGACYWINDOWSSTDIO'] = 'utf-8'
        
        process = subprocess.Popen(
            [sys.executable, '-u', str(backend_file)],
            cwd=str(backend_dir),
            stdout=subprocess.PIPE,
            stderr=subprocess.PIPE,
            text=True,
            bufsize=1,
            startupinfo=startupinfo,
            env=env,
            encoding='utf-8',
            errors='replace'
        )
        
        print("âœ… Backend process started!")
        return process
        
    except Exception as e:
        print(f"âŒ Error starting backend: {e}")
        sys.exit(1)

def wait_for_backend():
    """à¸£à¸­à¹ƒà¸«à¹‰ backend à¸à¸£à¹‰à¸­à¸¡à¹ƒà¸Šà¹‰à¸‡à¸²à¸™"""
    print(f"\nâ³ Waiting for backend to be ready (max {MAX_STARTUP_WAIT}s)...")
    
    start_time = time.time()
    dots = 0
    
    while time.time() - start_time < MAX_STARTUP_WAIT:
        if is_backend_ready(BACKEND_HOST, BACKEND_PORT):
            print("\nâœ… Backend is ready!")
            return True
        
        # à¹à¸ªà¸”à¸‡ progress
        dots = (dots + 1) % 4
        print(f"\r   Checking{'.' * dots}{' ' * (3 - dots)}", end='', flush=True)
        time.sleep(CHECK_INTERVAL)
    
    print("\nâš ï¸  Backend is taking longer than expected to start")
    print("   Continuing anyway... Check backend logs if there are issues")
    return False

def open_frontend():
    """à¹€à¸›à¸´à¸” Frontend à¹ƒà¸™à¹€à¸šà¸£à¸²à¸§à¹Œà¹€à¸‹à¸­à¸£à¹Œ"""
    print("\nğŸŒ Opening Frontend...")
    
    if not FRONTEND_FILE.exists():
        print(f"âŒ Frontend file not found: {FRONTEND_FILE}")
        return False
    
    try:
        # à¸ªà¸£à¹‰à¸²à¸‡ URL à¸ªà¸³à¸«à¸£à¸±à¸šà¹€à¸›à¸´à¸”à¹ƒà¸™à¹€à¸šà¸£à¸²à¸§à¹Œà¹€à¸‹à¸­à¸£à¹Œ
        url = FRONTEND_FILE.as_uri()
        print(f"   ğŸ“„ Opening: {url}")
        
        # à¹€à¸›à¸´à¸”à¹ƒà¸™à¹€à¸šà¸£à¸²à¸§à¹Œà¹€à¸‹à¸­à¸£à¹Œà¹€à¸£à¸´à¹ˆà¸¡à¸•à¹‰à¸™
        webbrowser.open(url)
        print("âœ… Frontend opened in browser!")
        return True
        
    except Exception as e:
        print(f"âŒ Error opening frontend: {e}")
        print(f"   Please open manually: {FRONTEND_FILE}")
        return False

def print_instructions():
    """à¹à¸ªà¸”à¸‡à¸„à¸³à¹à¸™à¸°à¸™à¸³à¸à¸²à¸£à¹ƒà¸Šà¹‰à¸‡à¸²à¸™"""
    instructions = f"""
    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    â•‘                                                       â•‘
    â•‘                  âœ… SYSTEM RUNNING                    â•‘
    â•‘                                                       â•‘
    â•‘  Backend:  http://{BACKEND_HOST}:{BACKEND_PORT}                     â•‘
    â•‘  Frontend: Opened in your default browser            â•‘
    â•‘                                                       â•‘
    â•‘  ğŸ“ Press Ctrl+C to stop the application             â•‘
    â•‘                                                       â•‘
    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    """
    print(instructions)

def print_backend_output(process):
    """à¹à¸ªà¸”à¸‡ output à¸ˆà¸²à¸ backend (à¸–à¹‰à¸²à¸¡à¸µ)"""
    try:
        if process and process.poll() is not None:
            # Process has terminated
            stdout, stderr = process.communicate(timeout=1)
            if stderr:
                print(f"\nâš ï¸  Backend Error Output:\n{stderr}")
    except:
        pass

def cleanup(backend_process):
    """à¸›à¸´à¸”à¹‚à¸›à¸£à¹à¸à¸£à¸¡à¸­à¸¢à¹ˆà¸²à¸‡à¸–à¸¹à¸à¸•à¹‰à¸­à¸‡"""
    print("\n\nğŸ›‘ Shutting down...")
    
    if backend_process:
        print("   Stopping backend server...")
        
        # à¸ªà¹ˆà¸‡ SIGTERM à¸à¹ˆà¸­à¸™ (graceful shutdown)
        backend_process.terminate()
        
        try:
            # à¸£à¸­ 5 à¸§à¸´à¸™à¸²à¸—à¸µ
            backend_process.wait(timeout=5)
            print("   âœ… Backend stopped successfully")
        except subprocess.TimeoutExpired:
            # à¸–à¹‰à¸²à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸›à¸´à¸” à¹ƒà¸Šà¹‰ SIGKILL
            print("   âš ï¸  Force killing backend...")
            backend_process.kill()
            try:
                backend_process.wait(timeout=2)
                print("   âœ… Backend killed")
            except:
                print("   âš ï¸  Backend process may still be running")
        
        # à¹à¸ªà¸”à¸‡ error output à¸–à¹‰à¸²à¸¡à¸µ
        print_backend_output(backend_process)
    
    print("\nğŸ‘‹ Thank you for using SMART VILLAGE MANAGEMENT SYSTEM!")
    print("=" * 60)

# ==================== Main Function ====================

def main():
    """à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¸«à¸¥à¸±à¸à¸‚à¸­à¸‡à¹‚à¸›à¸£à¹à¸à¸£à¸¡"""
    backend_process = None
    
    try:
        # 1. à¹à¸ªà¸”à¸‡ banner
        print_banner()
        
        # 2. à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š Python version
        check_python_version()
        
        # 3. à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š dependencies
        check_dependencies()
        
        # 4. à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¹„à¸Ÿà¸¥à¹Œà¸—à¸µà¹ˆà¸ˆà¸³à¹€à¸›à¹‡à¸™
        check_files()
        
        # 5. à¹€à¸£à¸´à¹ˆà¸¡à¸•à¹‰à¸™ Backend
        backend_process = run_backend()
        
        # 6. à¸£à¸­à¹ƒà¸«à¹‰ Backend à¸à¸£à¹‰à¸­à¸¡
        wait_for_backend()
        
        # 7. à¹€à¸›à¸´à¸” Frontend
        open_frontend()
        
        # 8. à¹à¸ªà¸”à¸‡à¸„à¸³à¹à¸™à¸°à¸™à¸³
        print_instructions()
        
        # 9. à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸§à¹ˆà¸² backend à¸¢à¸±à¸‡à¸—à¸³à¸‡à¸²à¸™à¸­à¸¢à¸¹à¹ˆà¸«à¸£à¸·à¸­à¹„à¸¡à¹ˆ
        print("ğŸ”„ Monitoring backend process...")
        print("   (Application will continue running until you press Ctrl+C)\n")
        
        # à¸£à¸­à¹ƒà¸«à¹‰à¸œà¸¹à¹‰à¹ƒà¸Šà¹‰à¸à¸” Ctrl+C à¸«à¸£à¸·à¸­ backend à¸›à¸´à¸”à¹€à¸­à¸‡
        while True:
            time.sleep(1)
            
            # à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸§à¹ˆà¸² backend à¸¢à¸±à¸‡à¸—à¸³à¸‡à¸²à¸™à¸­à¸¢à¸¹à¹ˆà¸«à¸£à¸·à¸­à¹„à¸¡à¹ˆ
            if backend_process.poll() is not None:
                print("\nâš ï¸  Backend process has stopped unexpectedly!")
                print_backend_output(backend_process)
                break
        
    except KeyboardInterrupt:
        # à¸œà¸¹à¹‰à¹ƒà¸Šà¹‰à¸à¸” Ctrl+C
        print("\n\nâš ï¸  Interrupt received...")
        
    except Exception as e:
        print(f"\nâŒ Unexpected error: {e}")
        import traceback
        traceback.print_exc()
        
    finally:
        # à¸›à¸´à¸”à¹‚à¸›à¸£à¹à¸à¸£à¸¡à¸­à¸¢à¹ˆà¸²à¸‡à¸–à¸¹à¸à¸•à¹‰à¸­à¸‡
        cleanup(backend_process)

# ==================== Entry Point ====================

if __name__ == "__main__":
    # à¸ˆà¸±à¸”à¸à¸²à¸£ Ctrl+C à¸šà¸™ Windows
    if sys.platform == 'win32':
        signal.signal(signal.SIGINT, lambda x, y: sys.exit(0))
    
    main()
